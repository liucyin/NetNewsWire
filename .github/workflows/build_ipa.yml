name: Build NetNewsWire iOS IPA

on:
  workflow_dispatch:
  push:
    tags:
      - "ios-v*"

jobs:
  build:
    name: Build & Package (iOS)
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Generate SecretKey.swift (empty)
        run: |
          set -euo pipefail

          # SecretKey.swift is gitignored. Generate it from the .gyb template so the build can compile.
          PROJECT_DIR="$GITHUB_WORKSPACE" bash buildscripts/updateSecrets.sh

      - name: Build NetNewsWire-iOS (Release, unsigned)
        run: |
          set -euo pipefail
          xcodebuild -version
          xcodebuild -showsdks

          mkdir -p build_ios
          xcodebuild build \
            -scheme "NetNewsWire-iOS" \
            -configuration Release \
            -derivedDataPath build_ios \
            -resultBundlePath build_ios/NetNewsWire-iOS.xcresult \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee build_ios/xcodebuild.log

      - name: Package unsigned IPA
        run: |
          set -euo pipefail
          cd build_ios/Build/Products/Release-iphoneos

          rm -rf Payload
          mkdir -p Payload
          ditto "NetNewsWire.app" "Payload/NetNewsWire.app"
          /usr/bin/zip -qr "NetNewsWire_unsigned.ipa" Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NetNewsWire-iOS-IPA
          path: build_ios/Build/Products/Release-iphoneos/NetNewsWire_unsigned.ipa

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NetNewsWire-iOS-BuildLogs
          path: |
            build_ios/xcodebuild.log
            build_ios/NetNewsWire-iOS.xcresult
